name: Hardware Testing

on:
  workflow_dispatch:
    inputs:
      hardware_target:
        description: 'MacBook model to test'
        required: true
        default: 'macbook2_1'
        type: choice
        options:
        - macbook2_1
        - macbook3_1
        - macbookpro2_2
        - generic_macbook
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday

jobs:
  hardware-matrix:
    name: Test Hardware Compatibility
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        hardware: [macbook2_1, macbook3_1, macbookpro2_2, generic_macbook]
        bootstrap: [ssd_swap, network, macos_installer]
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install testing dependencies
      run: |
        pip install -r testing/requirements.txt
        
    - name: Test bootstrap method
      run: |
        python3 testing/bootstrap_validation/bootstrap_validator.py \
          --hardware ${{ matrix.hardware }} \
          --method ${{ matrix.bootstrap }} \
          --ci-mode
          
    - name: Generate compatibility report
      run: |
        python3 testing/hardware_tests/generate_report.py \
          --hardware ${{ matrix.hardware }} \
          --method ${{ matrix.bootstrap }}
          
    - name: Upload test results
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.hardware }}-${{ matrix.bootstrap }}
        path: testing/results/
  
  update-compatibility-matrix:
    name: Update Hardware Matrix
    needs: hardware-matrix
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download test results
      uses: actions/download-artifact@v3
      with:
        path: testing/results/
        
    - name: Update compatibility matrix
      run: |
        python3 testing/hardware_tests/update_matrix.py
        
    - name: Commit updated matrix
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/hardware/compatibility_matrix.md
        git commit -m "ðŸ¤– Update hardware compatibility matrix" || exit 0
        git push
